---
- name: Get current datetime
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Check system datetime
      shell: date +"%H:%M:%S %d %b %Y"
      register: system_datetime
    - name: Set datetime as fact
      set_fact: datetime={{ system_datetime.stdout }}

- name: Basic configuration
  hosts: all
  gather_facts: false
  roles: 
    - basic-config

- name: RBAC configuration
  hosts: BR3
  gather_facts: false
  roles: 
    - rbac

- name: Config archive configuration
  hosts: HQ1
  gather_facts: false
  roles: 
    - config-backup

- name: SNMP configuration
  hosts: HQ1:FW1
  gather_facts: false
  roles: 
    - snmp

- name: Switching configuration
  hosts: switches
  gather_facts: false
  roles: 
    - vtp 
    - vlans 
    - lag
    - stp
    - switchports

- name: DHCP snooping and ARP inspection configuration
  hosts: SW1
  gather_facts: false
  roles: 
    - dhcp-snooping
    - dai

- name: Routed interfaces and SSH configuration 
  hosts: all
  gather_facts: false
  roles: 
    - routed-ports
    - ssh

- name: Gather facts for hosts with static DHCP configuration
  hosts: RADIUS
  gather_facts: true

- name: DHCP server configuration
  hosts: HQ1
  gather_facts: false
  roles: 
    - dhcp-server

- name: Routing and ACLs configuration
  hosts: routers:firewalls
  gather_facts: false
  roles: 
    - acl
    - routing
    - routing-auth

- name: FHRP configuration
  hosts: HQ1:HQ2
  gather_facts: false
  roles: 
    - fhrp

- name: BGP ACLs
  hosts: HQ1
  gather_facts: false
  tasks:
    - name: Set BGP distribute list
      ios_config:
        lines: 
          - neighbor 20.17.5.1 distribute-list ACL_DENY_BGP_IN in
          - neighbor 192.168.30.253 distribute-list ACL_DENY_BGP_IN in
        parents: 
          - router bgp 65001
          - address-family ipv4

- name: Local routing policy
  hosts: HQ1
  gather_facts: false
  tasks:
    - name: Set route-map for local routing policy
      ios_config:
        lines:
          - match ip address ACL_RM_LP
          - set ip next-hop 20.17.5.1
        parents: route-map RM_LOCAL_POLICY permit 10
    - name: Set local routing policy
      ios_config:
        lines: ip local policy route-map RM_LOCAL_POLICY

- name: Configure routing redistribution
  hosts: BR2
  gather_facts: false
  tasks:
    - name: Set route-map for OSPF redistribution
      ios_config:
        lines: match ip address ACL_RED_OSPF
        parents: route-map RM_RED_OSPF permit 10
    - name: Configure OSPF redistribution
      ios_config:
        lines: redistribute ospf 1 metric 1000000 0 255 1 1500 route-map RM_RED_OSPF
          parents: router eigrp 2017

- name: Configure NAT
  hosts: HQ1:HQ2
  gather_facts: false
  tasks:
    - name: Configure NAT inside interfaces
      ios_config:
        lines: ip nat inside
        parents: interface GigabitEthernet0/1.101
      async: 15
      poll: 5
    - name: Configure NAT outside interfaces
      ios_config:
        lines: ip nat outside
        parents: interface GigabitEthernet0/2
      async: 15
      poll: 5
    - name: Configure NAT statement
      ios_config:
        lines: ip nat inside source list ACL_FOR_NAT interface GigabitEthernet0/2 overload